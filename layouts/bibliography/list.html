{{ define "main" }}

  {{ .Content }}

  <style>
    /* Publication list styling */
    ul.pub-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    ul.pub-list > li {
      margin: 0;
      padding: .75rem 0;
      border-bottom: 1px solid #e2e2e2;
    }
    ul.pub-list > li:last-child {
      border-bottom: none;
    }
  </style>

  {{- $previewWordLimit := 24 -}}
  {{ $pages := .RegularPages }}

  {{- warnf "Pages: %v" (len $pages) -}}

  {{ if not (gt (len $pages) 0) }}
    <p>No publications found.</p>
  {{ end }}

  {{- /* Sort by date descending, then title ascending */ -}}
  {{- $pages = sort $pages "Date" "desc" -}}
  {{- $pages = sort $pages "Title" "asc" -}}

  {{- /* Render the list of publications */ -}}

  <ul class="pub-list">
    {{ range $pages }}
      <li>
        {{- $rawTitle := or .Params.title .Title -}}
        {{- $rendered := replaceRE "^<p>(.*)</p>$" "$1" $rawTitle -}}
        {{- /* The plainify corrupts values that look like HTML but aren't: "Special files on <Test>ARs>" */ -}}
        {{- /* $rendered = $rendered | plainify | htmlEscape */ -}}
        {{- $rendered = $rendered | htmlEscape -}}
        <a href="{{ .RelPermalink }}"><span><strong>{{- $rendered | safeHTML -}}</strong></span></a><br>

        {{- /* warnf "Parameters %v " .Params */ -}} 

      {{- $authors := .Params.authors -}}
      {{- $editors := .Params.editors -}}
      {{- $isPatent := eq .Params.item_type "patent" -}}
      {{- /* warnf "authors: %v" $authors */ -}}
      {{- if or $authors $editors -}}
        {{- if $authors -}}
          {{- if reflect.IsSlice $authors -}}
            {{- if $isPatent }}
              Inventors: 
            {{ end }}
              {{ delimit $authors "; " "; and " }}
          {{- else -}}
            {{- if $isPatent }}
              Inventor: 
            {{ end }}
              {{ $authors }}
          {{- end -}}
        {{- else -}}
          Edited by: 
          {{ if reflect.IsSlice $editors -}}
             {{ delimit $editors "; " "; and " }}
          {{- else -}}
              {{ $editors }}
          {{- end -}}
        {{- end -}}
      <br>
      {{- end -}}

        {{- /* Safe date: use front matter date only if non-empty & matches basic pattern */ -}}
        {{- $d := .Date -}}
        {{- with .Params.date -}}
          {{- $datestr := trim . " " -}}
          {{- if and (ne $datestr "") (findRE `^\d{4}-\d{2}-\d{2}` $datestr) -}}
            {{- $d = time $datestr -}}
          {{- end -}}
        {{- end }}
        {{- $d = $d.Format "2006-01-02" -}}
        {{- /* Don't display bogus date */ -}}
        {{- if (ne $d "0001-01-01") }}
          <time datetime="{{ $d }}">{{ $d }}</time><br>
        {{ end -}}

        {{ with .Params.abstract -}}
          {{- /* can't plainify, as above */ -}}
          {{- /* $plain := . | plainify | htmlEscape | replaceRE `\s+` " " */ -}}
          {{- $plain := . | htmlEscape | replaceRE `\s+` " " -}}
          {{- $previewing := gt (countwords $plain) $previewWordLimit -}}
          {{- $preview := "" -}}
          {{- if $previewing -}}
            {{- $previewWords := split $plain " " | first $previewWordLimit -}}
            {{- $preview = delimit $previewWords " " -}}
          {{- else -}}
            {{- $preview = replace . "\n" "<br>" -}}
          {{- end -}}
          <br>
          <div>{{ $preview | safeHTML }}{{ if $previewing }}â€¦{{ end }}</div>
          <br>
      {{- end -}}
      </li>
    {{ end }}
  </ul>
{{ end }}